{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "description": "DecoyLayer Infrastructure-as-Code Main Template - Deploys customer-owned components",
    "author": "DecoyLayer",
    "version": "1.0.0"
  },
  "parameters": {
    "tenantId": {
      "type": "string",
      "metadata": {
        "description": "Target tenant ID for validation and decoy deployment"
      }
    },
    "resourceSuffix": {
      "type": "string",
      "defaultValue": "",
      "minLength": 0,
      "maxLength": 6,
      "metadata": {
        "description": "Optional suffix for resource names (max 6 chars, alphanumeric). Use to ensure unique names when recreating resources."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "westeurope",
      "allowedValues": [
        "eastus",
        "westus2", 
        "westeurope",
        "northeurope"
      ],
      "metadata": {
        "description": "Azure region for resource deployment"
      }
    },
    "features": {
      "type": "object",
      "defaultValue": {
        "identity_decoys": true,
        "mailbox_bec": true,
        "sharepoint_docs": false,
        "teams_trap": false,
        "keyvault_honey": false,
        "devops_tokens": false
      },
      "metadata": {
        "description": "Feature toggles for different decoy types"
      }
    },
    "relayOutboundUrl": {
      "type": "string",
      "defaultValue": "https://api-dev.decoylayer.com/ingest",
      "metadata": {
        "description": "DecoyLayer ingest endpoint URL"
      }
    },
    "hmacKey": {
      "type": "secureString",
      "defaultValue": "",
      "metadata": {
        "description": "HMAC key generated in DecoyLayer portal (copy from previous step)"
      }
    },
    "deploymentId": {
      "type": "string",
      "defaultValue": "[uniqueString(parameters('tenantId'), parameters('resourceSuffix'))]",
      "metadata": {
        "description": "Unique deployment identifier"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "Product": "DecoyLayer",
        "Environment": "Customer", 
        "ManagedBy": "DecoyLayer"
      },
      "metadata": {
        "description": "Resource tags"
      }
    }
  },
  "variables": {
    "resourceGroupName": "[concat('dl-', uniqueString(parameters('tenantId'), parameters('resourceSuffix')), '-rg')]",
    "keyVaultName": "[concat('dl-', uniqueString(parameters('tenantId'), parameters('resourceSuffix')), '-kv')]",
    "keyVaultUri": "[concat('https://', concat('dl-', uniqueString(parameters('tenantId'), parameters('resourceSuffix')), '-kv'), '.vault.azure.net/')]",
    "eventHubNamespaceName": "[concat('dl-', uniqueString(parameters('tenantId'), parameters('resourceSuffix')), '-ehns')]",
    "eventHubName": "decoylayer-logs",
    "functionAppName": "[concat('dl-', uniqueString(parameters('tenantId'), parameters('resourceSuffix')), '-func')]",
    "storageAccountName": "[concat('dl', uniqueString(parameters('tenantId'), parameters('resourceSuffix')), 'st')]",
    "appServicePlanName": "[concat('dl-', uniqueString(parameters('tenantId'), parameters('resourceSuffix')), '-plan')]",
    "deploymentTags": "[union(parameters('tags'), createObject('DeploymentId', parameters('deploymentId')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2022-09-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('deploymentTags')]",
      "properties": {}
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "allResourcesDeployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "dependsOn": [
        "[variables('resourceGroupName')]"
      ],
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "storageAccountName": { "type": "string" },
            "keyVaultName": { "type": "string" },
            "keyVaultUri": { "type": "string" },
            "eventHubNamespaceName": { "type": "string" },
            "eventHubName": { "type": "string" },
            "appServicePlanName": { "type": "string" },
            "functionAppName": { "type": "string" },
            "location": { "type": "string" },
            "deploymentTags": { "type": "object" },
            "tenantId": { "type": "string" },
            "relayOutboundUrl": { "type": "string" },
            "deploymentId": { "type": "string" },
            "hmacKey": { "type": "securestring" },
            "features": { "type": "object" }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('deploymentTags')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "supportsHttpsTrafficOnly": true,
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false,
                "networkAcls": {
                  "defaultAction": "Allow"
                }
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-02-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('deploymentTags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[parameters('tenantId')]",
                "enableRbacAuthorization": true,
                "enablePurgeProtection": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 90,
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            },
            {
              "type": "Microsoft.EventHub/namespaces",
              "apiVersion": "2022-10-01-preview",
              "name": "[parameters('eventHubNamespaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('deploymentTags')]",
              "sku": {
                "name": "Standard",
                "tier": "Standard",
                "capacity": 1
              },
              "properties": {
                "minimumTlsVersion": "1.2",
                "isAutoInflateEnabled": false
              }
            },
            {
              "type": "Microsoft.EventHub/namespaces/eventhubs",
              "apiVersion": "2022-10-01-preview",
              "name": "[concat(parameters('eventHubNamespaceName'), '/', parameters('eventHubName'))]",
              "dependsOn": [
                "[parameters('eventHubNamespaceName')]"
              ],
              "properties": {
                "messageRetentionInDays": 3,
                "partitionCount": 2
              }
            },
            {
              "type": "Microsoft.EventHub/namespaces/authorizationRules",
              "apiVersion": "2022-10-01-preview",
              "name": "[concat(parameters('eventHubNamespaceName'), '/listen')]",
              "dependsOn": [
                "[parameters('eventHubNamespaceName')]"
              ],
              "properties": {
                "rights": ["Listen"]
              }
            },
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-09-01",
              "name": "[parameters('appServicePlanName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('deploymentTags')]",
              "sku": {
                "name": "Y1",
                "tier": "Dynamic"
              },
              "properties": {
                "reserved": false
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2022-09-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('deploymentTags')]",
              "kind": "functionapp",
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
              ],
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
                "httpsOnly": true,
                "siteConfig": {
                  "netFrameworkVersion": "v8.0",
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value)]"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "dotnet-isolated"
                    },
                    {
                      "name": "DOTNET_VERSION",
                      "value": "8.0"
                    },
                    {
                      "name": "WEBSITE_RUN_FROM_PACKAGE", 
                      "value": "https://raw.githubusercontent.com/decoylayer/decoylayer-templates/main/customer-function/release/decoylayer-controller-v1.2.zip"
                    },
                    {
                      "name": "DECOYLAYER_INGEST_URL",
                      "value": "[parameters('relayOutboundUrl')]"
                    },
                    {
                      "name": "DECOYLAYER_TENANT_ID",
                      "value": "[parameters('tenantId')]"
                    },
                    {
                      "name": "DECOYLAYER_DEPLOYMENT_ID",
                      "value": "[parameters('deploymentId')]"
                    },
                    {
                      "name": "EVENTHUB_CONNECTION_STRING",
                      "value": "[concat('Endpoint=sb://', parameters('eventHubNamespaceName'), '.servicebus.windows.net/;SharedAccessKeyName=listen;SharedAccessKey=', listKeys(resourceId('Microsoft.EventHub/namespaces/authorizationRules', parameters('eventHubNamespaceName'), 'listen'), '2022-10-01-preview').primaryKey)]"
                    },
                    {
                      "name": "KEY_VAULT_NAME",
                      "value": "[parameters('keyVaultName')]"
                    },
                    {
                      "name": "DECOYLAYER_FEATURES",
                      "value": "[string(parameters('features'))]"
                    },
                    {
                      "name": "HMAC_SECRET",
                      "value": "[concat('@Microsoft.KeyVault(SecretUri=', parameters('keyVaultUri'), 'secrets/dl-hmac/)')]"
                    }
                  ],
                  "minimumElasticInstanceCount": 0
                }
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-02-01",
              "name": "[concat(parameters('keyVaultName'), '/dl-hmac')]",
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ],
              "properties": {
                "value": "[parameters('hmacKey')]"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), resourceId('Microsoft.Web/sites', parameters('functionAppName')), '4633458b-17de-408a-b874-0445c86b69e6')]",
              "scope": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ],
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2022-09-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        },
        "parameters": {
          "storageAccountName": { "value": "[variables('storageAccountName')]" },
          "keyVaultName": { "value": "[variables('keyVaultName')]" },
          "keyVaultUri": { "value": "[variables('keyVaultUri')]" },
          "eventHubNamespaceName": { "value": "[variables('eventHubNamespaceName')]" },
          "eventHubName": { "value": "[variables('eventHubName')]" },
          "appServicePlanName": { "value": "[variables('appServicePlanName')]" },
          "functionAppName": { "value": "[variables('functionAppName')]" },
          "location": { "value": "[parameters('location')]" },
          "deploymentTags": { "value": "[variables('deploymentTags')]" },
          "tenantId": { "value": "[parameters('tenantId')]" },
          "relayOutboundUrl": { "value": "[parameters('relayOutboundUrl')]" },
          "deploymentId": { "value": "[parameters('deploymentId')]" },
          "hmacKey": { "value": "[parameters('hmacKey')]" },
          "features": { "value": "[parameters('features')]" }
        }
      }
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[variables('resourceGroupName')]"
    },
    "functionAppName": {
      "type": "string", 
      "value": "[variables('functionAppName')]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[variables('keyVaultName')]"
    },
    "eventHubNamespace": {
      "type": "string",
      "value": "[variables('eventHubNamespaceName')]"
    },
    "deploymentId": {
      "type": "string",
      "value": "[parameters('deploymentId')]"
    },
    "deploymentInstructions": {
      "type": "array",
      "value": [
        "âœ… DecoyLayer infrastructure deployed successfully!",
        "",
        "ðŸ“‹ Deployment Summary:",
        "[concat('â€¢ Resource Group: ', variables('resourceGroupName'))]",
        "[concat('â€¢ Function App: ', variables('functionAppName'))]",
        "[concat('â€¢ Deployment ID: ', parameters('deploymentId'))]",
        "[concat('â€¢ Features Enabled: ', string(parameters('features')))]",
        "",
        "ðŸ”— Next Steps:",
        "1. Return to DecoyLayer Portal and verify deployment status",
        "2. Test Function heartbeat endpoint (may take 2-3 minutes to be ready)",
        "3. Verify first alerts appear within 5-10 minutes",
        "4. Review Features tab to enable additional decoys",
        "",
        "ðŸ›Ÿ Support:",
        "â€¢ Documentation: https://docs.decoylayer.com",
        "â€¢ Status Page: https://status.decoylayer.com",
        "â€¢ Support Portal: https://support.decoylayer.com"
      ]
    },
    "heartbeatUrl": {
      "type": "string",
      "value": "[concat('https://', variables('functionAppName'), '.azurewebsites.net/api/heartbeat')]"
    }
  }
}